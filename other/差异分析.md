## 差异分析

#### 1.limma 得到差异表达矩阵

```R
rm(list = ls())
#################################################
exprSet <- read.table("data/GSE42872_series_matrix.txt.gz",
                      comment.char = "!",
                      stringsAsFactors = F,
                      header = T)
### 第一列变成行名
rownames(exprSet) <- exprSet[, 1]
exprSet <- exprSet[, -1]
################################################
### 2.数据预处理，探针ID转换，探针去重
## 自动log化，解释
ex <- exprSet
qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm = T))
LogC <- (qx[5] > 100) ||
  (qx[6] - qx[1] > 50 && qx[2] > 0) ||
  (qx[2] > 0 && qx[2] < 1 && qx[4] > 1 && qx[4] < 2)

## 开始判断
if (LogC) {
  ex[which(ex <= 0)] <- NaN
  ## 取log2
  exprSet <- log2(ex)
  print("log2 transform finished")
}else {
  print("log2 transform not needed")
}

library(limma)
boxplot(exprSet, outline = FALSE, notch = T, las = 2)
### 该函数默认使用quntile 矫正差异
exprSet = normalizeBetweenArrays(exprSet)
boxplot(exprSet, outline = FALSE, notch = T, las = 2)
exprSet <- as.data.frame(exprSet)

#################################################################
### 3.探针基因名转换
platformMap <- data.table::fread("resource/platformMap.txt", data.table = F)

## 平台的名称如何知道?
index <- "GPL6244"
paste0(platformMap$bioc_package[grep(index, platformMap$gpl)], ".db")
library(hugene10sttranscriptcluster.db)
probe2symbol_df <- toTable(get("hugene10sttranscriptclusterSYMBOL"))

#################################################################
### 4.探针转换以及去重，获得最终的表达矩阵
### 拆分体会,要学会分步探索排查，#号的使用
library(dplyr)
library(tibble)
exprSet1 <- exprSet %>%
  rownames_to_column("probe_id") %>%
  inner_join(probe2symbol_df, by = "probe_id") %>%
  select(-probe_id) %>%
  select(symbol, everything()) %>%
  mutate(rowMean = rowMeans(.[, -1])) %>%
  arrange(desc(rowMean)) %>%
  distinct(symbol, .keep_all = T) %>%
  select(-rowMean) %>%
  column_to_rownames("symbol")

#################################################################
### 5.使用limma来做芯片的差异分析
### 1.创建分组
group <- c(rep("con", 3), rep("treat", 3))
### levels里面，把对照组放在前面
group <- factor(group, levels = c("con", "treat"))

### 主成分分析PCA：提前预测结果
### 行是样本列是基因
res.pca <- prcomp(t(exprSet1), scale = TRUE)
library(factoextra)
fviz_pca_ind(res.pca, col.ind = group)

### 构建比较矩阵
design <- model.matrix(~group)
### 比较矩阵命名
colnames(design) <- levels(group)

### 2.线性模型拟合
fit <- lmFit(exprSet1, design)
### 3.贝叶斯检验
fit2 <- eBayes(fit)
### 4.输出差异分析结果,其中coef的数目不能操过design的列数
### 此处的2代表的是design中第二列和第一列的比较
allDiff = topTable(fit2, adjust = 'fdr', coef = 2, number = Inf)
###################################################################################
### 定义差异基因：差异倍数2倍，矫正后的p值小于0.05
library(dplyr)
diffgene <- allDiff %>%
  filter(adj.P.Val < 0.05) %>%
  filter(abs(logFC) > 1)

diffgene2 <- subset(allDiff, abs(logFC) > 1 & adj.P.Val < 0.05)
```

#### 作图

```R
## 作图环节
### 1.探针ID转换，2.行列转置，3，添加分组信息。最终获得的是数据框
exprSet <- as.data.frame(t(exprSet1))
dd <- cbind(group = group, exprSet)

## 2.作图展示一个差异基因
my_comparisons <- list(
  c("treat", "con")
)
library(ggpubr)

## 改写成函数
diffplot <- function(gene) {
  my_comparisons <- list(
    c("treat", "con")
  )
  library(ggpubr)
  ggboxplot(
    dd, x = "group", y = gene,
    color = "group", palette = c("#00AFBB", "#E7B800"),
    add = "jitter"
  ) +
    stat_compare_means(comparisons = my_comparisons, method = "t.test")
}

diffplot("CD36")
diffplot("MOXD1")

## 3.作图展示多个差异基因
genelist <- rownames(exprSet1)[1:6]
data <- dd[, c("group", genelist)]
library(tidyr)
data9 <- data %>%
  pivot_longer(cols = -1,
               names_to = "gene",
               values_to = "expression")
## 多基因作图
ggplot(data = data9, aes(x = group, y = expression, fill = group)) +
  geom_boxplot() +
  geom_jitter() +
  theme_bw() +
  facet_grid(. ~ gene) +
  stat_compare_means(comparisons = my_comparisons, label = "p.signif", method = "t.test")

##################################################
### 4.作图展示一群差异基因
###  画热图，以及掌握热图的用法

library(dplyr)
diffgene <- allDiff %>%
  filter(adj.P.Val < 0.05) %>%
  filter(abs(logFC) > 3)
## 3.用名称提取部分数据用作热图绘制
heatdata <- exprSet1[rownames(diffgene),]
## 4.制作一个分组信息用于注释
group <- c(rep("con", 3), rep("treat", 3))
annotation_col <- data.frame(group)
rownames(annotation_col) <- colnames(heatdata)
library(pheatmap)
library(viridisLite)
### 经过修饰的图
pheatmap(heatdata, #热图的数据
         cluster_rows = TRUE, #行聚类
         cluster_cols = TRUE, #列聚类，可以看出样本之间的区分度
         annotation_col = annotation_col, #标注样本分类
         annotation_legend = TRUE, # 显示注释
         show_rownames = T, # 显示行名
         scale = "row", #以行来标准化，这个功能很不错
         color = viridis(10, alpha = 1, begin = 0.5, end = 1, direction = 1), #调色
         #filename = "heatmap_F.pdf",#是否保存
         cellwidth = 30, # 格子宽度
         cellheight = 12, # 格子高度
         fontsize = 10 # 字体大小
)

##################################################
### 5.作图展示所有基因差异
### 画火山图，订制火山图
library(ggplot2)
library(ggrepel)
library(dplgeneyr)

data <- allDiff
data$gene <- rownames(data)

logFCfilter = 1
logFCcolor = 3
### 标记上下调
index = data$adj.P.Val < 0.05 & abs(data$logFC) > logFCfilter
data$group <- 0
data$group[index & data$logFC > 0] = 1
data$group[index & data$logFC < 0] = -1
data$group <- factor(data$group, levels = c(1, 0, -1), labels = c("Up", "NS", "Down"))
### 正式画图
ggplot(data = data, aes(x = logFC, y = -log10(adj.P.Val), color = group)) +
  geom_point(alpha = 0.8, size = 1.2) +
  scale_color_manual(values = c("darkred", "black", "royalblue4")) +
  labs(x = "log2 (fold change)", y = "-log10 (adj.P.Val)") +
  theme(plot.title = element_text(hjust = 0.4)) +
  geom_hline(yintercept = -log10(0.05), lty = 4, lwd = 0.6, alpha = 0.8) +
  geom_vline(xintercept = c(-logFCfilter, logFCfilter), lty = 4, lwd = 0.6, alpha = 0.8) +
  theme_bw() +
  theme(panel.border = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line = element_line(colour = "black")) +
  theme(legend.position = "top") +
  geom_point(data = subset(data, abs(logFC) >= logFCcolor & adj.P.Val < 0.05), alpha = 0.8, size = 3, col = "green2") +
  geom_text_repel(data = subset(data, abs(logFC) >= logFCcolor & adj.P.Val < 0.05),
                  aes(label = gene), col = "black", alpha = 0.8)

##################################################
### 6.探索基因变化带来的功能改变
### 基因集富集分析GSEA的用法
################################################
## 解释原理
library(clusterProfiler)
gene <- rownames(allDiff)
gene = bitr(gene, fromType = "SYMBOL", toType = "ENTREZID", OrgDb = "org.Hs.eg.db")

## 去重
gene <- dplyr::distinct(gene, SYMBOL, .keep_all = TRUE)
gene_df <- data.frame(logFC = allDiff$logFC,
                      SYMBOL = rownames(allDiff))
gene_df <- merge(gene_df, gene, by = "SYMBOL")


geneList <- gene_df$logFC
names(geneList) = gene_df$SYMBOL
geneList = sort(geneList, decreasing = TRUE)


### GSEA 变化在于gene set
### hallmarks gene set
hallmarks <- read.gmt("resource/h.all.v7.1.symbols.gmt")
### 主程序GSEA
y <- GSEA(geneList, TERM2GENE = hallmarks)
yd <- as.data.frame(y)

### 看整体分布
library(ggplot2)
dotplot(y, showCategory = 30, split = ".sign") + facet_grid(~.sign)

### 选择需要呈现的来作图
library(enrichplot)
gseaplot2(y, "HALLMARK_E2F_TARGETS", color = "red", pvalue_table = T)
gseaplot2(y, 10, color = "red", pvalue_table = T)
gseaplot2(y, geneSetID = 1:3)
```

#### 2. DEseq2

```R
rm(list = ls())
### https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE153250
### 1.读入表达矩阵
### 要求, 行数基因，列是样本，内容是counts(正整数)
exprSet <- data.table::fread("data/exprSet_counts.csv", data.table = F)
#########################################################
### 2.准备 metadata文件
### (用于注释样本信息，至少两列，一列是样本名称，一列是分组信息)
metadata <- data.table::fread("data/metadata.txt", data.table = F, header = F)
rownames(metadata) <- metadata[, 1]
metadata <- metadata[colnames(exprSet)[-1],]
### 添加分组信息
metadata$group <- ifelse(grepl("ESR1", metadata$V2), "treat", "control")
metadata = metadata[, c(1, 3)]
colnames(metadata) <- c("sample", "group")
#########################################################
### 3.核心环节，构建dds对象
### 要记住四个参数
### 要有数据countData，这里就是exprSet
### 要有分组信息，在colData中，这里是metadata
### design部分是分组信息，格式是~group
### 第一列如果是基因名称，需要自动处理，设置参数tidy=TRUE
### 对象是个复合体
library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = exprSet,
                              colData = metadata,
                              design = ~group,
                              tidy = TRUE)
### 筛选样本，counts函数提取表达量数据
dds <- dds[rowSums(counts(dds)) > 1,]
#########################################################
### 4.数据质量判断
### vst标准化处理
vsd <- vst(dds, blind = FALSE)
### 内置函数plotPCA进行主成分分析画图
plotPCA(vsd, "group")
### 用内置函数plotCounts来进行快速，简易作图
### 找到阳性基因,此处ESR1
### dds来自于上一步
### gene 输入的是ensemble ID
### intgroup 输入的是metadata中分组信息
plotCounts(dds, gene = "ENSG00000091831", intgroup = c("group"))

### 导出标准化后的表达数据
### assay函数提取vst标准化后的数据，保存数据用于热图
exprSet_vst <- as.data.frame(assay(vsd))
### 保存数据,用于表达量作图，比如差异分析，热图
#########################################################
### 5.正式运行DESeq主程序
### 依次经过下面几步
### estimating size factors
### estimating dispersions
### gene-wise dispersion estimates
### mean-dispersion relationship
### final dispersion estimates
### fitting model and testing
dds <- DESeq(dds)
#########################################################
### 6.logFC矫正，RNAseq很重要的一步
### contrast参数设置
### 依次是，1.分组信息(metadata中的列) 2.处理组，3.对照组
contrast = c("group", "treat", "control")
### results函数获取差异分析的结果
dd1 <- results(dds, contrast = contrast, alpha = 0.05)
### 内置函数plotMA作图
plotMA(dd1, ylim = c(-5, 5))
### logFC矫正
dd2 <- lfcShrink(dds, contrast = contrast, res = dd1, type = "ashr")
plotMA(dd2, ylim = c(-5, 5))
#########################################################
### 7.导出差异分析的结果
library(dplyr)
library(tibble)
library(tidyr)
res <- dd2 %>%
  as.data.frame() %>%
  rownames_to_column("gene_id")
#########################################################
### 8.基因注释
### 当前基因名称是ENSEMBL
library(AnnotationDbi)
library(org.Hs.eg.db)
### 增加基因名称SYMBOL
res$symbol <- mapIds(org.Hs.eg.db,
                     keys = res$gene_id,
                     column = "SYMBOL",
                     keytype = "ENSEMBL",
                     multiVals = "first")
### 增加ENTREZID
res$entrez <- mapIds(org.Hs.eg.db,
                     keys = res$gene_id,
                     column = "ENTREZID",
                     keytype = "ENSEMBL",
                     multiVals = "first")
### 修改logFC，p值的名称，为的是跟火山图的代码匹配
colnames(res) <- c("gene_id", "baseMean", "logFC", "lfcSE", "P.Value", "adj.P.Val", "gene", "entrez")
```
## 差异分析

```R
rm(list = ls())
#################################################
exprSet <- read.table("data/GSE42872_series_matrix.txt.gz",
                      comment.char = "!",
                      stringsAsFactors = F,
                      header = T)
### 第一列变成行名
rownames(exprSet) <- exprSet[, 1]
exprSet <- exprSet[, -1]
################################################
### 2.数据预处理，探针ID转换，探针去重
## 自动log化，解释
ex <- exprSet
qx <- as.numeric(quantile(ex, c(0., 0.25, 0.5, 0.75, 0.99, 1.0), na.rm = T))
LogC <- (qx[5] > 100) ||
  (qx[6] - qx[1] > 50 && qx[2] > 0) ||
  (qx[2] > 0 && qx[2] < 1 && qx[4] > 1 && qx[4] < 2)

## 开始判断
if (LogC) {
  ex[which(ex <= 0)] <- NaN
  ## 取log2
  exprSet <- log2(ex)
  print("log2 transform finished")
}else {
  print("log2 transform not needed")
}

library(limma)
boxplot(exprSet, outline = FALSE, notch = T, las = 2)
### 该函数默认使用quntile 矫正差异
exprSet = normalizeBetweenArrays(exprSet)
boxplot(exprSet, outline = FALSE, notch = T, las = 2)
exprSet <- as.data.frame(exprSet)

#################################################################
### 3.探针基因名转换
platformMap <- data.table::fread("resource/platformMap.txt", data.table = F)

## 平台的名称如何知道?
index <- "GPL6244"
paste0(platformMap$bioc_package[grep(index, platformMap$gpl)], ".db")
library(hugene10sttranscriptcluster.db)
probe2symbol_df <- toTable(get("hugene10sttranscriptclusterSYMBOL"))

#################################################################
### 4.探针转换以及去重，获得最终的表达矩阵
### 拆分体会,要学会分步探索排查，#号的使用
library(dplyr)
library(tibble)
exprSet1 <- exprSet %>%
  rownames_to_column("probe_id") %>%
  inner_join(probe2symbol_df, by = "probe_id") %>%
  select(-probe_id) %>%
  select(symbol, everything()) %>%
  mutate(rowMean = rowMeans(.[, -1])) %>%
  arrange(desc(rowMean)) %>%
  distinct(symbol, .keep_all = T) %>%
  select(-rowMean) %>%
  column_to_rownames("symbol")

#################################################################
### 5.使用limma来做芯片的差异分析
### 1.创建分组
group <- c(rep("con", 3), rep("treat", 3))
### levels里面，把对照组放在前面
group <- factor(group, levels = c("con", "treat"))

### 主成分分析PCA：提前预测结果
### 行是样本列是基因
res.pca <- prcomp(t(exprSet1), scale = TRUE)
library(factoextra)
fviz_pca_ind(res.pca, col.ind = group)

### 构建比较矩阵
design <- model.matrix(~group)
### 比较矩阵命名
colnames(design) <- levels(group)

### 2.线性模型拟合
fit <- lmFit(exprSet, design)
### 3.贝叶斯检验
fit2 <- eBayes(fit)
### 4.输出差异分析结果,其中coef的数目不能操过design的列数
### 此处的2代表的是design中第二列和第一列的比较
allDiff = topTable(fit2, adjust = 'fdr', coef = 2, number = Inf)
###################################################################################
### 定义差异基因：差异倍数2倍，矫正后的p值小于0.05
library(dplyr)
diffgene <- allDiff %>%
  filter(adj.P.Val < 0.05) %>%
  filter(abs(logFC) > 1)

diffgene2 <- subset(allDiff, abs(logFC) > 1 & adj.P.Val < 0.05)
```
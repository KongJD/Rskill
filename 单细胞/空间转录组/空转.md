## 空间转录组

### 1.Introduction
```R
library(Seurat) 
library(tidyverse)
library(sloop)


## 10x Visium
seu_vis <- Load10X_Spatial(data.dir = "data/human_lymph_node/",
                           filename = "V1_Human_Lymph_Node_filtered_feature_bc_matrix.h5")

image <- Read10X_Image(image.dir = "data/human_lymph_node/spatial/", image.name = "tissue_hires_image.png")
seu_vis_hires <- Load10X_Spatial(data.dir = "data/human_lymph_node/", image = image,
                                 filename = "V1_Human_Lymph_Node_filtered_feature_bc_matrix.h5")

class(seu_vis[["slice1"]])
head(seu_vis[["slice1"]]@coordinates)
class(seu_vis[["slice1"]]@image)
dim(seu_vis[["slice1"]]@image)

head(GetTissueCoordinates(seu_vis))
head(GetTissueCoordinates(seu_vis[["slice1"]]))
s3_dispatch(GetTissueCoordinates(seu_vis[["slice1"]]))

ScaleFactors(seu_vis[["slice1"]])

head(slot(seu_vis[["slice1"]], name = "coordinates"))

View(slot(seu_vis[["slice1"]], name = "coordinates"))

data.use <- seu_vis[["slice1"]]@coordinates
p1 <- ggplot(data.use, aes(row, col)) + geom_point(size = 2)
p2 <- ggplot(data.use, aes(imagerow, imagecol)) + geom_point(size = 2)
p1 + p2

data.use <- GetTissueCoordinates(seu_vis)
p3 <- ggplot(data.use, aes(imagerow, imagecol)) + geom_point(size = 2)

p1 + p2 + p3



library(grid)
library(gridExtra)
slice1 <- seu_vis[["slice1"]]@image

grid.raster(slice1)

slice1.R <- slice1[,,1]
slice1.G <- slice1[,,2]
slice1.B <- slice1[,,3]

img1 = rasterGrob(slice1.R)
img2 = rasterGrob(slice1.G)
img3 = rasterGrob(slice1.B)

grid.arrange(img1, img2, img3, nrow=1)

df = data.frame(
  red = matrix(slice1[,,1], ncol=1),
  green = matrix(slice1[,,2], ncol=1),
  blue = matrix(slice1[,,3], ncol=1)
)

K = kmeans(df,4)
df$label = K$cluster

C1 = matrix(df$label==1, nrow=dim(slice1)[1])
C2 = matrix(df$label==2, nrow=dim(slice1)[1])
C3 = matrix(df$label==3, nrow=dim(slice1)[1])
C4 = matrix(df$label==4, nrow=dim(slice1)[1])

img0 <- rasterGrob(slice1)
img1 <- rasterGrob(C1)
img2 <- rasterGrob(C2)
img3 <- rasterGrob(C3)
img4 <- rasterGrob(C4)
grid.arrange(img0, img1, img2, img3, img4, nrow=1)

colors = data.frame(
  label = 1:nrow(K$centers),
  R = K$centers[,"red"],
  G = K$centers[,"green"],
  B = K$centers[,"blue"]
)

df$order = 1:nrow(df)
df = merge(df, colors)
df = df[order(df$order),]
df$order = NULL

# get mean color channel values for each row of the df.
R = matrix(df$R, nrow=dim(slice1)[1])
G = matrix(df$G, nrow=dim(slice1)[1])
B = matrix(df$B, nrow=dim(slice1)[1])

slice1_segmented = array(dim=dim(slice1))
slice1_segmented[,,1] = R
slice1_segmented[,,2] = G
slice1_segmented[,,3] = B


img1 = rasterGrob(slice1)
img2 = rasterGrob(slice1_segmented)
grid.arrange(img1, img2, nrow=1)


img0 <- rasterGrob(slice1_segmented)
img1 <- rasterGrob(slice1)
grid.arrange(img0, img1, nrow=1)
```